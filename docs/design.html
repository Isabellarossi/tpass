
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>1   Design Rationale &#8212; tpass 0.1.7 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="1   Contribute" href="contribute.html" />
    <link rel="prev" title="1   Manual" href="manual.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="design-rationale">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Design Rationale</a><a class="headerlink" href="#design-rationale" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="the-tiny-table-of-contents">
<p class="topic-title first">The tiny table of contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#design-rationale" id="id1">1&nbsp;&nbsp;&nbsp;Design Rationale</a><ul class="auto-toc">
<li><a class="reference internal" href="#introduction" id="id2">1.1&nbsp;&nbsp;&nbsp;Introduction</a></li>
<li><a class="reference internal" href="#privacy" id="id3">1.2&nbsp;&nbsp;&nbsp;Privacy</a></li>
<li><a class="reference internal" href="#cryptography" id="id4">1.3&nbsp;&nbsp;&nbsp;Cryptography</a><ul class="auto-toc">
<li><a class="reference internal" href="#entropy" id="id5">1.3.1&nbsp;&nbsp;&nbsp;Entropy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#syncing" id="id6">1.4&nbsp;&nbsp;&nbsp;Syncing</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">1.1&nbsp;&nbsp;&nbsp;Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Tpass is build with simplicity in mind. All should be 100% compatible with
Trezor Password Manager. It is build with unix philosophy in mind, every output
could be the input for another application, which means it’s scriptable. The
application is cross plattform and runs on Linux,Windows and MacOS. All the
crypto implementation is handled by Trezor Device. The Input and CLI methods are
implemented with click.</p>
</div>
<div class="section" id="privacy">
<h2><a class="toc-backref" href="#id3">1.2&nbsp;&nbsp;&nbsp;Privacy</a><a class="headerlink" href="#privacy" title="Permalink to this headline">¶</a></h2>
<p>There are two mods aviable for handling metadata</p>
</div>
<div class="section" id="cryptography">
<h2><a class="toc-backref" href="#id4">1.3&nbsp;&nbsp;&nbsp;Cryptography</a><a class="headerlink" href="#cryptography" title="Permalink to this headline">¶</a></h2>
<p>Trezor has provided python implementations for the decryption functions of the
TPM. Tpass has implented the complement encryption function.</p>
<div class="section" id="entropy">
<h3><a class="toc-backref" href="#id5">1.3.1&nbsp;&nbsp;&nbsp;Entropy</a><a class="headerlink" href="#entropy" title="Permalink to this headline">¶</a></h3>
<p>All the random data needed for generating the initialization vector iv is
taken from os.random() and the trezor device 50:50, with the following function:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getEntropy</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">trezor_entropy</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">get_entropy</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">length</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">urandom_entropy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="n">length</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">entropy</span> <span class="o">=</span> <span class="n">trezor_entropy</span> <span class="o">+</span> <span class="n">urandom_entropy</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entropy</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; bytes entropy expected&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entropy</span>
</pre></div>
</div>
<p>Storage decryption function is taking from trezorlib/python/tools/pwd_ready.py
-&gt; decryptStorage, the shown encrytion function is implemented by tpass.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">encryptStorage</span><span class="p">(</span><span class="n">db_json</span><span class="p">,</span> <span class="n">store_path</span><span class="p">,</span> <span class="n">encKey</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>
    <span class="n">cipherkey</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">encKey</span><span class="p">)</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">cipherkey</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">GCM</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
    <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
    <span class="n">cipherText</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">db_json</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
    <span class="n">cipherText</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">tag</span> <span class="o">+</span> <span class="n">cipherText</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">store_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cipherText</span><span class="p">)</span>
</pre></div>
</div>
<p>Similar entry decryption function is taking from trezorlib/python/tools/
pwd_ready.py -&gt; decryptEntryValue, the shown encrytion function is implemented
by tpass.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">encryptEntryValue</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>
    <span class="n">cipherkey</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">cipherkey</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">GCM</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
    <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
    <span class="n">cipherText</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
    <span class="n">cipherText</span> <span class="o">=</span> <span class="n">iv</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">tag</span> <span class="o">+</span> <span class="n">cipherText</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cipherText</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="syncing">
<h2><a class="toc-backref" href="#id6">1.4&nbsp;&nbsp;&nbsp;Syncing</a><a class="headerlink" href="#syncing" title="Permalink to this headline">¶</a></h2>
<p>There are three cloud options aviable and offline mode. When the password file
is read on startup, by the <cite>unlock_storage</cite> method, than a lockfile is created
~/.tpass/tpass.lock and is deleted on normal exit or when a exception occurs.
If a second instance of tpass is trying to read the password file, it discovers
the lockfile and exits. When saving changes to the password file, it is also
checked by timestamp, if it changed in the meantime and only proceeds on an
unchanged pwd file.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="manual.html" title="previous chapter">1&nbsp;&nbsp;&nbsp;Manual</a></li>
      <li>Next: <a href="contribute.html" title="next chapter">1&nbsp;&nbsp;&nbsp;Contribute</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, makk4.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.7</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="_sources/design.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>